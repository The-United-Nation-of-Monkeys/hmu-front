# Backend API Endpoints Documentation

## 1. Загрузка Excel/CSV файла со статьями расходов (Government)

### POST `/government/grants/{grant_id}/spending-items/upload`

**Описание:** Позволяет грантодателю загрузить Excel или CSV файл со списком статей расходов для гранта.

**Требования:**
- Пользователь должен быть аутентифицирован как `government`
- Грант должен существовать и принадлежать текущему пользователю
- Файл должен быть в формате `.xlsx`, `.xls` или `.csv`

**Формат файла:**
Файл должен содержать следующие колонки:
- `Title` (обязательно) - название статьи расходов
- `Description` (опционально) - описание статьи расходов
- `Amount` (обязательно) - сумма в рублях (число)

**Пример CSV:**
```csv
Title,Description,Amount
Оборудование,Закупка компьютеров,500000
Зарплата,Оплата труда сотрудников,1000000
Командировки,Расходы на командировки,200000
```

**Пример Excel:**
Та же структура, но в формате Excel.

**Request:**
- Method: `POST`
- Content-Type: `multipart/form-data`
- Body:
  - `file`: File (Excel или CSV)

**Response:**
```json
{
  "created": 3,
  "items": [
    {
      "id": 1,
      "grant_id": 1,
      "title": "Оборудование",
      "description": "Закупка компьютеров",
      "amount": 500000,
      "created_at": "2024-01-01T00:00:00"
    },
    // ... другие элементы
  ]
}
```

**Ошибки:**
- `400 Bad Request` - неверный формат файла или данных
- `401 Unauthorized` - не аутентифицирован
- `403 Forbidden` - не является владельцем гранта
- `404 Not Found` - грант не найден
- `422 Unprocessable Entity` - ошибки валидации данных в файле

**Что нужно сделать на бэке:**
1. Проверить аутентификацию и роль пользователя
2. Проверить существование гранта и права доступа
3. Распарсить файл (использовать библиотеку типа `pandas`, `openpyxl` для Python)
4. Валидировать данные:
   - Title обязателен и не пустой
   - Amount обязателен, должен быть положительным числом
   - Description опционален
5. Создать записи `SpendingItem` в базе данных
6. Вернуть количество созданных записей и список созданных элементов

---

## 2. Получение списка грантополучателей (University)

### GET `/university/grantees`

**Описание:** Возвращает список всех доступных грантополучателей для назначения на гранты.

**Требования:**
- Пользователь должен быть аутентифицирован как `university`

**Request:**
- Method: `GET`
- Headers: `Authorization: Bearer <token>`

**Response:**
```json
[
  {
    "id": 1,
    "email": "grantee1@example.com",
    "name": "Иван Иванов",
    "role": "grantee"
  },
  {
    "id": 2,
    "email": "grantee2@example.com",
    "name": "Петр Петров",
    "role": "grantee"
  }
]
```

**Ошибки:**
- `401 Unauthorized` - не аутентифицирован
- `403 Forbidden` - не является университетом

**Что нужно сделать на бэке:**
1. Проверить аутентификацию и роль пользователя
2. Получить всех пользователей с ролью `grantee` из базы данных
3. Вернуть список с полями: `id`, `email`, `name`, `role`

---

## 3. Назначение грантополучателя на грант (University)

### POST `/university/grants/{grant_id}/assign-grantee`

**Описание:** Позволяет университету назначить грантополучателя на конкретный грант.

**Требования:**
- Пользователь должен быть аутентифицирован как `university`
- Грант должен существовать и быть связан с текущим университетом
- Грантополучатель должен существовать

**Request:**
- Method: `POST`
- Headers: `Authorization: Bearer <token>`
- Body:
```json
{
  "grantee_id": 1
}
```

**Response:**
```json
{
  "id": 1,
  "title": "Грант на исследования",
  "description": "Описание гранта",
  "total_amount": 1000000,
  "currency": "RUB",
  "government_id": 1,
  "university_id": 1,
  "grantee_id": 1,
  "created_at": "2024-01-01T00:00:00",
  "updated_at": "2024-01-01T00:00:00"
}
```

**Ошибки:**
- `400 Bad Request` - неверные данные (grantee_id отсутствует)
- `401 Unauthorized` - не аутентифицирован
- `403 Forbidden` - не является университетом или грант не принадлежит университету
- `404 Not Found` - грант или грантополучатель не найден

**Что нужно сделать на бэке:**
1. Проверить аутентификацию и роль пользователя
2. Проверить существование гранта и что `university_id` гранта соответствует текущему пользователю
3. Проверить существование грантополучателя с указанным `grantee_id`
4. Обновить поле `grantee_id` в записи гранта
5. Вернуть обновленный объект гранта

---

## 4. Получение статей расходов для грантополучателя (Grantee)

### GET `/grantee/grants/{grant_id}/spending-items`

**Описание:** Возвращает список статей расходов для конкретного гранта, доступных грантополучателю.

**Требования:**
- Пользователь должен быть аутентифицирован как `grantee`
- Грант должен существовать и быть назначен на текущего грантополучателя (`grantee_id` должен совпадать с ID текущего пользователя)

**Request:**
- Method: `GET`
- Headers: `Authorization: Bearer <token>`

**Response:**
```json
[
  {
    "id": 1,
    "grant_id": 1,
    "title": "Оборудование",
    "description": "Закупка компьютеров",
    "amount": 500000,
    "created_at": "2024-01-01T00:00:00"
  },
  {
    "id": 2,
    "grant_id": 1,
    "title": "Зарплата",
    "description": "Оплата труда сотрудников",
    "amount": 1000000,
    "created_at": "2024-01-01T00:00:00"
  }
]
```

**Ошибки:**
- `401 Unauthorized` - не аутентифицирован
- `403 Forbidden` - не является грантополучателем или грант не назначен на него
- `404 Not Found` - грант не найден

**Что нужно сделать на бэке:**
1. Проверить аутентификацию и роль пользователя
2. Проверить существование гранта
3. Проверить, что `grantee_id` гранта соответствует ID текущего пользователя
4. Получить все `SpendingItem` для данного гранта
5. Вернуть список статей расходов

---

## Общие замечания

### Аутентификация
Все эндпоинты требуют JWT токен в заголовке:
```
Authorization: Bearer <token>
```

### Валидация данных
- Все ID должны быть положительными целыми числами
- Суммы должны быть положительными числами
- Email должен быть валидным форматом
- Названия не должны быть пустыми

### Обработка ошибок
Все ошибки должны возвращаться в формате:
```json
{
  "detail": "Описание ошибки"
}
```

### База данных
Рекомендуется добавить следующие поля в таблицу `grants`:
- `university_id` (INTEGER, FOREIGN KEY) - ID университета
- `grantee_id` (INTEGER, FOREIGN KEY, NULLABLE) - ID грантополучателя (может быть NULL до назначения)

### Логирование
Рекомендуется логировать:
- Все операции создания/обновления
- Ошибки валидации
- Попытки доступа без прав

---

## 5. Загрузка чека для статьи расходов (Grantee)

### POST `/grantee/spending-items/{spending_item_id}/receipt`

**Описание:** Позволяет грантополучателю загрузить чек для конкретной статьи расходов.

**Требования:**
- Пользователь должен быть аутентифицирован как `grantee`
- Статья расходов должна существовать
- Грант, к которому относится статья расходов, должен быть назначен на текущего грантополучателя
- Файл должен быть в формате изображения (`.png`, `.jpg`, `.jpeg`) или PDF (`.pdf`)

**Request:**
- Method: `POST`
- Content-Type: `multipart/form-data`
- Headers: `Authorization: Bearer <token>`
- Body:
  - `file`: File (изображение или PDF)

**Response:**
```json
{
  "id": 1,
  "spending_item_id": 1,
  "file_url": "https://storage.example.com/receipts/receipt_123.pdf",
  "uploaded_at": "2024-01-01T00:00:00"
}
```

**Ошибки:**
- `400 Bad Request` - неверный формат файла или файл слишком большой
- `401 Unauthorized` - не аутентифицирован
- `403 Forbidden` - не является грантополучателем или грант не назначен на него
- `404 Not Found` - статья расходов не найдена
- `422 Unprocessable Entity` - ошибки валидации файла

**Что нужно сделать на бэке:**
1. Проверить аутентификацию и роль пользователя
2. Проверить существование статьи расходов (`SpendingItem`)
3. Проверить, что грант, к которому относится статья расходов, назначен на текущего грантополучателя:
   - Получить грант по `grant_id` из статьи расходов
   - Проверить, что `grantee_id` гранта соответствует ID текущего пользователя
4. Валидировать файл:
   - Проверить формат (только изображения и PDF)
   - Проверить размер (рекомендуется максимум 10MB)
5. Сохранить файл в хранилище (локальное хранилище, S3, или другое)
6. Обновить поле `receipt_url` в записи `SpendingItem` в базе данных
7. Создать запись `Receipt` в базе данных (если используется отдельная таблица)
8. Вернуть информацию о загруженном чеке

**Примечания:**
- Если чек уже загружен, его можно заменить новым файлом
- Рекомендуется сохранять старые версии чеков для аудита
- URL файла должен быть доступен для просмотра (публичный доступ или с авторизацией)

**Структура базы данных:**
Рекомендуется добавить поле `receipt_url` в таблицу `spending_items`:
```sql
ALTER TABLE spending_items ADD COLUMN receipt_url VARCHAR(500);
```

Или создать отдельную таблицу `receipts`:
```sql
CREATE TABLE receipts (
    id SERIAL PRIMARY KEY,
    spending_item_id INTEGER REFERENCES spending_items(id),
    spending_request_id INTEGER REFERENCES spending_requests(id),
    file_url VARCHAR(500) NOT NULL,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    uploaded_by INTEGER REFERENCES users(id)
);
```

